---

title: z instancji na instancje.
date: '2008-07-02T01:43:00.000+02:00'
author: kaarol
tags:
- Oprogramowanie Serwerowe
modified_time: '2015-02-23T23:51:44.087+01:00'
blogger_id: tag:blogger.com,1999:blog-1272990746006552071.post-7898419472511039173
blogger_orig_url: http://www.it-flow.pl/2008/07/z-instancji-na-instancje.html
---

Podczas zakończenia testowego wdrożenia Windows 2008 Server natrafiłem na następujący problem: <em>Jak te wszystkie serwery przenieść na wersje RTM. </em><br/><br/>Na samym początku brałem pod uwagę upgrade, jednak po krótkiej chwili stwierdziłem, że to nie dla mnie. Podczas tych 4 miesięcy zabawy z Windows 2008 namieszałem tak dużo, że utrzymywanie tych systemów było nie lada wyzwaniem. Po kilkunastu godzinach robienia kopi serwerów oraz sprawdzania czy o czymś nie zapomniałem stanąłem przed największym wyzwanie:) Jak przenieść całą instancje SQL? Tzn. właściwie bazy danych oraz wszystkie konta wraz z identycznymi hasłami etc.<br/><br/><strong>Pomysły początkowe:</strong><br/><ul><br/>	<li> pełna kopia instancji i restor ( nie ma czegos takiego:))</li><br/>	<li>zrobienie detach na wszystkich bazach, podmiana ścieżek systemowych (nie da się tego zrobić tak prosto z bazami systemowymi).</li><br/></ul><br/><strong>Jak więc sobie poradzić ??</strong><br/><br/>Odpowiedz jest prosta przenieść bazy a konta skopiować za pomocą skryptu :D Tak, tak  skrypt trzeba napisać.  Na szczęście skrypt można znaleźć na stronie supportu microsoft (<a href="http://support.microsoft.com/kb/918992/">Opis po angielsku</a>).<br/><br/><strong>Wymagania:</strong><br/><ul><br/>	<li>Zainstalowany SQL Server 2005 na obu serwerach lub dwie instancje na jednym serwerze.</li><br/>	<li>Podstawowa wiedza o wykonywaniu zapytań, kopi baz.</li><br/></ul><br/><strong>Procedura przenoszenia baz i loginów:</strong><br/><ul><br/>	<li> Wykonujemy pełny backup wszystkich baz oraz logów transakcyjnych.</li><br/>	<li>Na serwerze z którego rezygnujemy wykonujemy Detach każdej bazy danych którą chcemy przenieść poza systemowymi. Odłączone bazy kopiujemy na drugi serwer. I wykonujemy ich dołączenie (Atache)</li><br/>	<li>Na serwerze A tworzymy nowe zapytanie w Sql Server Managment Studio (SSMS), jako treść wklejamy poniższy skrypt:<font color="#999999"><br/>USE master</font><br/><font color="#999999"> </font><font color="#999999">GO</font><br/><font color="#999999"> IF OBJECT_ID ('sp_hexadecimal') IS NOT NULL<br/>DROP PROCEDURE sp_hexadecimal<br/>GO<br/>CREATE PROCEDURE sp_hexadecimal<br/>@binvalue varbinary(256),<br/>@hexvalue varchar (514) OUTPUT<br/>AS<br/>DECLARE @charvalue varchar (514)<br/>DECLARE @i int<br/>DECLARE @length int<br/>DECLARE @hexstring char(16)<br/>SELECT @charvalue = '0x'<br/>SELECT @i = 1<br/>SELECT @length = DATALENGTH (@binvalue)<br/>SELECT @hexstring = '0123456789ABCDEF'<br/>WHILE (@i &lt;= @length)<br/>BEGIN<br/>DECLARE @tempint int<br/>DECLARE @firstint int<br/>DECLARE @secondint int<br/>SELECT @tempint = CONVERT(int, SUBSTRING(@binvalue,@i,1))<br/>SELECT @firstint = FLOOR(@tempint/16)<br/>SELECT @secondint = @tempint - (@firstint*16)<br/>SELECT @charvalue = @charvalue +<br/>SUBSTRING(@hexstring, @firstint+1, 1) +<br/>SUBSTRING(@hexstring, @secondint+1, 1)<br/>SELECT @i = @i + 1<br/>END </font></li><br/></ul><br/><font color="#999999">SELECT @hexvalue = @charvalue<br/>GO</font><br/><br/><font color="#999999">IF OBJECT_ID ('sp_help_revlogin') IS NOT NULL<br/>DROP PROCEDURE sp_help_revlogin<br/>GO<br/>CREATE PROCEDURE sp_help_revlogin @login_name sysname = NULL AS<br/>DECLARE @name sysname<br/>DECLARE @type varchar (1)<br/>DECLARE @hasaccess int<br/>DECLARE @denylogin int<br/>DECLARE @is_disabled int<br/>DECLARE @PWD_varbinary  varbinary (256)<br/>DECLARE @PWD_string  varchar (514)<br/>DECLARE @SID_varbinary varbinary (85)<br/>DECLARE @SID_string varchar (514)<br/>DECLARE @tmpstr  varchar (1024)<br/>DECLARE @is_policy_checked varchar (3)<br/>DECLARE @is_expiration_checked varchar (3)</font><br/><br/><font color="#999999">DECLARE @defaultdb sysname</font><br/><br/><font color="#999999">IF (@login_name IS NULL)<br/>DECLARE login_curs CURSOR FOR</font><br/><br/><font color="#999999">SELECT p.sid, p.name, p.type, p.is_disabled, p.default_database_name, l.hasaccess, l.denylogin FROM<br/>sys.server_principals p LEFT JOIN sys.syslogins l<br/>ON ( l.name = p.name ) WHERE p.type IN ( 'S', 'G', 'U' ) AND p.name &lt;&gt; 'sa'<br/>ELSE<br/>DECLARE login_curs CURSOR FOR<br/>SELECT p.sid, p.name, p.type, p.is_disabled, p.default_database_name, l.hasaccess, l.denylogin FROM<br/>sys.server_principals p LEFT JOIN sys.syslogins l<br/>ON ( l.name = p.name ) WHERE p.type IN ( 'S', 'G', 'U' ) AND p.name = @login_name<br/>OPEN login_curs</font><br/><br/><font color="#999999">FETCH NEXT FROM login_curs INTO @SID_varbinary, @name, @type, @is_disabled, @defaultdb, @hasaccess, @denylogin<br/>IF (@@fetch_status = -1)<br/>BEGIN<br/>PRINT 'No login(s) found.'<br/>CLOSE login_curs<br/>DEALLOCATE login_curs<br/>RETURN -1<br/>END<br/>SET @tmpstr = '/* sp_help_revlogin script '<br/>PRINT @tmpstr<br/>SET @tmpstr = '** Generated ' + CONVERT (varchar, GETDATE()) + ' on ' + @@SERVERNAME + ' */'<br/>PRINT @tmpstr<br/>PRINT ''<br/>WHILE (@@fetch_status &lt;&gt; -1)<br/>BEGIN<br/>IF (@@fetch_status &lt;&gt; -2)<br/>BEGIN<br/>PRINT ''<br/>SET @tmpstr = '-- Login: ' + @name<br/>PRINT @tmpstr<br/>IF (@type IN ( 'G', 'U'))<br/>BEGIN -- NT authenticated account/group</font><br/><br/><font color="#999999">SET @tmpstr = 'CREATE LOGIN ' + QUOTENAME( @name ) + ' FROM WINDOWS WITH DEFAULT_DATABASE = [' + @defaultdb + ']'<br/>END<br/>ELSE BEGIN -- SQL Server authentication<br/>-- obtain password and sid<br/>SET @PWD_varbinary = CAST( LOGINPROPERTY( @name, 'PasswordHash' ) AS varbinary (256) )<br/>EXEC sp_hexadecimal @PWD_varbinary, @PWD_string OUT<br/>EXEC sp_hexadecimal @SID_varbinary,@SID_string OUT</font><br/><br/><font color="#999999">-- obtain password policy state<br/>SELECT @is_policy_checked = CASE is_policy_checked WHEN 1 THEN 'ON' WHEN 0 THEN 'OFF' ELSE NULL END FROM sys.sql_logins WHERE name = @name<br/>SELECT @is_expiration_checked = CASE is_expiration_checked WHEN 1 THEN 'ON' WHEN 0 THEN 'OFF' ELSE NULL END FROM sys.sql_logins WHERE name = @name</font><br/><br/><font color="#999999">SET @tmpstr = 'CREATE LOGIN ' + QUOTENAME( @name ) + ' WITH PASSWORD = ' + @PWD_string + ' HASHED, SID = ' + @SID_string + ', DEFAULT_DATABASE = [' + @defaultdb + ']'</font><br/><br/><font color="#999999">IF ( @is_policy_checked IS NOT NULL )<br/>BEGIN<br/>SET @tmpstr = @tmpstr + ', CHECK_POLICY = ' + @is_policy_checked<br/>END<br/>IF ( @is_expiration_checked IS NOT NULL )<br/>BEGIN<br/>SET @tmpstr = @tmpstr + ', CHECK_EXPIRATION = ' + @is_expiration_checked<br/>END<br/>END<br/>IF (@denylogin = 1)<br/>BEGIN -- login is denied access<br/>SET @tmpstr = @tmpstr + '; DENY CONNECT SQL TO ' + QUOTENAME( @name )<br/>END<br/>ELSE IF (@hasaccess = 0)<br/>BEGIN -- login exists but does not have access<br/>SET @tmpstr = @tmpstr + '; REVOKE CONNECT SQL TO ' + QUOTENAME( @name )<br/>END<br/>IF (@is_disabled = 1)<br/>BEGIN -- login is disabled<br/>SET @tmpstr = @tmpstr + '; ALTER LOGIN ' + QUOTENAME( @name ) + ' DISABLE'<br/>END<br/>PRINT @tmpstr<br/>END</font><br/><br/><font color="#999999">FETCH NEXT FROM login_curs INTO @SID_varbinary, @name, @type, @is_disabled, @defaultdb, @hasaccess, @denylogin<br/>END<br/>CLOSE login_curs<br/>DEALLOCATE login_curs<br/>RETURN 0<br/>GO</font><br/><ul><br/>	<li>Wciskamy F5 jeśli wszystko poszło ok to powinniśmy zostać poinformowani o poprawnym wykonaniu skryptu. Aktualnie do bazy master zostały dodane dwie procedury:<br/><ul><br/>	<li>sp_hexadecimal</li><br/>	<li>sp_help_revlogin - pobiera z bazy danych loginy z hashem hasła, SID'em etc.</li><br/></ul><br/></li><br/>	<li>Wykonujemy <code> EXEC sp_help_revlogin </code> Wynikiem tej operacji powinien być pełny spis kont z docelowej instancji. Powyższy wypis zapisujemy na dysk lub pendrive.</li><br/>	<li>Łączymy się do docelowej instacji (B) i klikamy <em>new query</em>, w oknie wpisywania komend wklejamy wynik poprzednich operacji, który zapisalismy na dysku.</li><br/>	<li>Po wykoaniu skryptu system powinnien nam pokazać kilka błędów związanych z już isntniejącymi loginami a w spisie kont powinny pojawić się nowe konta.</li><br/></ul><br/><strong>Podsumowanie:</strong><br/><br/>Po wykonaniu powyższych kroków na nowej instancji powinniśmy mieć przeniesione bazy danych oraz użytkowników, którzy występowali na poprzedniej instancji.  Teraz tylko wystarczy poinformować użytkowników o nowym serwerze i czekać na zgłaszanie problemów.<br/><br/><a href="http://support.microsoft.com/kb/918992/"><br/></a>