---
layout: post
title: Cross Realm Trust.
date: '2010-07-13T22:04:00.000+02:00'
author: kaarol
tags:
- Active Directory
- Open Source
- Windows 7
modified_time: '2015-03-03T21:11:54.674+01:00'
thumbnail: http://2.bp.blogspot.com/-DiOgML0dDe0/VPYU9qVBcXI/AAAAAAAAABU/qAOQCIFAepM/s72-c/cross.png
blogger_id: tag:blogger.com,1999:blog-1272990746006552071.post-429841025073771644
blogger_orig_url: http://www.it-flow.pl/2010/07/cross-realm-trust.html
---

Migracje, migracje i jeszcze raz migracje. Od pewnego czasu siedzę i staram się poprawić i udoskonalić stare usługi, zaktualizować systemy, itd.<br /><br />Jedną z bardziej interesujących rzeczy jest migracja z Windows XP do Windows 7. Jak to zwykle bywa jednym z częstszych problemów jest odpowiednia konfiguracja systemów do współpracy z trustem między REALM-em MIT Kerberos a Active Directory.<br /><br />W Windows 7 Microsoft wprowadził sporo zmian część z nich dotyczy konfiguracji samego logowania do REALMu.<br /><br />Główne zmiany to:<br /><ul><br /><li>Uproszczenie konfiguracji samego REALMu na stacjach klienckich</li><br /><li>Wyłączenie przestarzałych mechanizmów szyfrowania (DES-CBC-{CRC,MD5})- <a href="http://technet.microsoft.com/en-us/library/dd560670%28WS.10%29.aspx">źródło</a></li><br /><li>Wprowadzenie odpowiedniego szablonu polis do konfiguracji REALMu<a name='more'></a></li></ul><br />Po instalacji Windows 7 i wpięciu systemu do domeny rozpocząłem konfigurację REALMu. Po małym przeglądnięciu kilku stron amerykańskich uniwersytetów okazało się, że konfiguracji realmu w Windows 7 nie przeprowadza się już za pomocą ksetup.exe:<br /><blockquote><span style="background-color: white;">ksetup.exe /addkdc nazwa_realmu nazwa_serwera_kdc_dla_podanego_realmu</span><br /><br /><span style="background-color: white;">ksetup.exe /domain nazwa_domyslnej _domeny</span></blockquote><br />Dla ułatwienia Microsoft utworzył odpowiedni szablon polis:<br /><div class="separator" style="clear: both; text-align: center;"></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-DiOgML0dDe0/VPYU9qVBcXI/AAAAAAAAABU/qAOQCIFAepM/s1600/cross.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-DiOgML0dDe0/VPYU9qVBcXI/AAAAAAAAABU/qAOQCIFAepM/s1600/cross.png" height="240" width="640" /></a></div><div style="text-align: center;"><br /></div><br />Na początku zainteresowałem się tylko dwiema opcjami:<br /><ul><br /><li>Define interoperable Kerberos V5 realm settings – opcja odpowiada za odpowiednią konfigurację realmu oraz serwerów KDC, które ma wykorzystać klient. W Windows XP konfiguracja tych ustawień dobywała się za pomocą ksetup.exe</li><br /><li>Require strict KDC validation – sprawdza pewne obostrzenia dotyczące certyfikatu serwera KDC.</li></ul><br />Dodatkowo skusiłem się na ustawienie DefaultLogonDomain na nazwę mojego Realmu. Jak większość pamięta od Visty z ekranu logowania zniknęła możliwość wyboru domeny/realmu logowania. Aktualnie użytkownik ma się logować za pomocą User Principal Name (<a href="mailto:login@nazwadomeny">login@nazwadomeny</a>). Ustawnie DefaultLogonDomain pozwala logować się do domyślnej domeny/realmu za pomocą samego loginu<br /><br />Jeśli, ktoś nie chce konfigurować tych ustawień za pomocą GPO to może wykorzystać odpowiedni wpisy w rejestrze<br /><blockquote>Windows Registry Editor Version 5.00<br /><br />[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System]<br />"DefaultLogonDomain"="Nazwa_Realmu"<br /><br />[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Kerberos]<br />"MitRealms_Enabled"=dword:00000001<br /><br />[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Kerberos\MitRealms]<br />"Nazwa_Realmu"="&lt;f&gt;0x00000008&lt;/f&gt;&lt;k&gt;serwer_kdc_1;serwer_kdc_2&lt;/k&gt;"<br /><br />[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Kerberos\Parameters]<br />"KdcValidation"=dword:00000002</blockquote><br />W przypadku trzeciego ustawienia (Define interoperable Kerberos V5 realm settings) między &lt;f&gt;&lt;/f&gt; podajemy w postaci hex-a listę opcji, które mają być wykorzystane podczas odpytywania serwerów KDC w danym realmie:<br /><ul><br /><li>0x00 None – brak flag</li><br /><li>0x01 SendAddress – pozwalaj na adresy IP w generowanych ticketach</li><br /><li>0x02 TcpSupported – serwery kluczy akceptują ruch TCP, wymagany przy dużych pakietach</li><br /><li>0x04 Delegate – każdy w realmie jest zaufany do delegacji</li><br /><li>0x08 NcSupported – podany realm wspiera Name Canonicalization</li></ul><br />Przepraszam za trochę lakoniczne tłumaczenie, więcej informacji o opcjach w <a href="http://technet.microsoft.com/en-us/library/cc736890%28WS.10%29.aspx">technecie</a>.<br /><br />Jeśli po konfiguracji nie udaje się zalogować do systemu. Występuje komunikat błędny login lub hasło, to najprawdopodobniej serwery kluczy wykorzystują mechanizmy DES-CBC-CRC lub DES-CBC-MD5, które w Windows 7 i Windows Server 2008 R2 zostały domyślnie wyłączone. Włącznie mechanizmów najlepiej wykonać za pomocą GPO:<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-2-PPk3-RIzU/VPYU-B5oWcI/AAAAAAAAABc/ksRKRU7eayY/s1600/cross2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-2-PPk3-RIzU/VPYU-B5oWcI/AAAAAAAAABc/ksRKRU7eayY/s1600/cross2.png" /></a></div><div style="text-align: center;"><br /></div><br />Tutaj taka drobna uwaga, którą podał <a href="http://www.w2k.pl/">Tomek Onyszko</a> na <a href="http://wss.pl/frmThread.aspx?tid=96159">wss.pl</a>. W niektórych przypadkach warto wyłączyć AES128 i AES256 jeśli nie jest on wykorzystywany.<br /><br />Po zmianie tych ustawień można się poprawnie zalogować używając MITowskiego realmu. Niestety po zalogowaniu na użytkownika nie zostały nadrzucone polisy oraz sam użytkownik nie miał dostępu do serwerów będących w domenie Windows. Co prawda w logach DC widać, że zaszło mapowanie użytkownika z realmu na użytkownika w AD jednak polecenie klist nie wyświetla wymaganych ticketów.<br /><br /><em>Po trzech dniach spędzonych przy Wiresharku postanowiłem zapytać na wss i jak zwykle w sprawach związanych z Kerberosem </em><a href="http://www.w2k.pl/"><em>Tomek Onyszko</em></a><em><a href="http://w2k.pl/"> </a>okazał się być bardzo pomocny. Nie wiem jak mu podziękować bo gdyby nie jego pomoc to nadal ślęczałbym nad ekranem z dumpem wiresharka.</em><br /><br />Poniżej postaram się krótko opisać gdzie tkwił problem.<br /><br />W przypadku zaufania między domenami czy realmami, komputer odpytuje odpowiednie serwery kluczy w celu pozyskania odpowiednich ticketów, które później będzie wykorzystywał do uzyskania dostępu do konkretnych serwerów. W tym poście nie będę tego jakoś szczególnie opisywał (dobry materiał na kolejny post). W skrócie jeśli klient nie dostanie ticketu z serwera kluczy z jednej domeny to prosi o odpowiedni ticket Granting Services, który pozwala mu odpytać kolejny serwer kluczy odpowiedniej domeny.<br /><br />Tak robił XP, który jest aktualnie na stanowiskach:<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-tfZ1zTBefh0/VPYU-M2SGHI/AAAAAAAAABg/MIOghwaAWcc/s1600/cross3.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-tfZ1zTBefh0/VPYU-M2SGHI/AAAAAAAAABg/MIOghwaAWcc/s1600/cross3.png" /></a></div><div style="text-align: center;"><br /></div><br />Powyższy zrzut ekranu obrazuje prośbę klienta o odpowiedni ticket na potrzeby dostępu do miejsca gdzie leża polisy:<br /><ol><br /><li>Klient prosi o TGS serwera KDC w realmie, w którym uwierzytelnił się użytkownik</li><br /><li>Serwer kluczy dla danego realmu zwraca informacje PRINCIPAL_UNKNOWN – informacja o określonym SPN znajduje się w innym serwerze kluczy ( w moim przypadku kontrolerze domeny z którą zestawiony był trust realm )</li><br /><li>Klient prosi o TGS (krbtgt/nazwa_realmu) ticket jest wymagany by klient mógł rozmawiać z zaufaną domeną</li><br /><li>Serwer kluczy w naszym realmie odsyła odpowiedni ticket</li><br /><li>Klient prosi kontroler domeny o określony ticket dla cifs/nazwa_kontrolera (strzałka 3 na zdjęciu), wykorzystując ticket, który otrzymał w kroku czwartym.</li><br /><li>Serwer zwraca odpowiedni ticket.</li><br /><li>Klient przystępuje do komunikacji z serwerem plików.</li></ol><br />W przypadku Windows 7 spraw wyglądała trochę gorzej ponieważ, system pomijał prośbę o TGS (krbtgt, oraz o odpowiedni ticket w zaufanej domenie i przeskakiwał na NTLM):<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-N0iGcelmnTc/VPYU-d0m5uI/AAAAAAAAABk/Zrh-jBo4htM/s1600/cross4.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-N0iGcelmnTc/VPYU-d0m5uI/AAAAAAAAABk/Zrh-jBo4htM/s1600/cross4.png" height="103" width="320" /></a></div><div style="text-align: center;"><br /></div><br />Jak widać na powyższym zrzucie ekranu klient:<br /><ol><br /><li>Pyta serwer kluczy dla wykorzystywanego realmu</li><br /><li>Serwer zwraca odpowiedź o braku Principala o określonej nazwie (2)</li><br /><li>Klient próbuje wykorzystać NTLM by dostać się do zasobów.</li><br /><li>Próba w dalszej części kończy się fiaskiem.</li></ol><br />Po pomocy Tomka okazało się że problem ten można rozwiązać poprzez wskazanie systemowi klienckiemu jakie nazwy realmow/lasow ma przeszukiwać. Można to skonfigurować w GPO ( pierwsze zdjęcie w wpisie) <em>Use forest search order. </em>Po dopisaniu tam <em>nazwa_realmu, nazwa_domeny_ad,</em> klient zaczyna odpytywać kontroler. Jedynym minusem który tutaj występuje jest brak zapytania ok określony&nbsp; TGS (krbt/…) jednak ticket ten zostaje pobrany na samym początku podczas logowania do domeny. Po ostatniej zmianie klient zaczyna poprawnie funkcjonować:<br /><ul><br /><li>pobierane są polisy dla użytkownika</li><br /><li>można uzyskać dostęp do określonych zasobów dyskowych w zaufanej domenie.</li></ul><br />Przyznam się, że problem jest dość ciekawy i w wolnej chwili trzeba się będzie trochę bardziej w niego zagłębić. Ale wcześniej muszę sobie skonfigurować wirtualnej środowisko by nie bawić się w zamazywanie zrzutów z Wiresharka. Przy okazji może uda mi się opisać proces konfiguracji Cross Realm Trusta.