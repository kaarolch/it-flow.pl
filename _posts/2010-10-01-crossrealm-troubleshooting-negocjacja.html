---

title: CrossRealm troubleshooting – Negocjacja wykorzystywanych typówszyfrowania.
date: '2010-10-01T23:41:00.000+02:00'
author: kaarol
tags:
- Active Directory
modified_time: '2015-03-03T21:13:46.320+01:00'
thumbnail: http://3.bp.blogspot.com/-bt1dKcsmL50/VPYU8hng4LI/AAAAAAAAABA/dDYUpWUbkXk/s72-c/2975693889_76dcf5eea6_z1_thumb.jpg
blogger_id: tag:blogger.com,1999:blog-1272990746006552071.post-1367766677305403084
blogger_orig_url: http://www.it-flow.pl/2010/10/crossrealm-troubleshooting-negocjacja.html
---

Jak ja kocham sieci heterogeniczne, gdyby nie one to życie byłoby takie nudne. A może wreszcie miałbym więcej czasu dla siebie?<br /><div style="text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-bt1dKcsmL50/VPYU8hng4LI/AAAAAAAAABA/dDYUpWUbkXk/s1600/2975693889_76dcf5eea6_z1_thumb.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-bt1dKcsmL50/VPYU8hng4LI/AAAAAAAAABA/dDYUpWUbkXk/s1600/2975693889_76dcf5eea6_z1_thumb.jpg" /></a></div><br /><div style="text-align: center;"><a href="http://creativecommons.org/licenses/by-nc-nd/2.0/deed.en">CC</a> - <a href="http://www.flickr.com/photos/resclassic/">Resclassic</a></div><br /><a name='more'></a>Kilka tygodni temu <a href="http://it-flow.pl/?p=317">opisywałem problemy w konfiguracji</a> trustu (cross realm trust’u) między MIT KDC i domeną Active Directory. Niby na maszynach wirtualnych wszystko działało. Użytkownicy mogli się zalogować, pobrać dane z AD, pobrać polisy czy uzyskać dostęp do udziałów sieciowych. Po kilku dniach; w sumie dwóch tygodniach klonowania, poprawiania tego co się źle sklonowało i instalowania tego czego zabrakło nadszedł czas na udostępnienie stacji użytkownikom. Na początku wszystko działało poprawnie. Jednak już po kilku godzinach pojawiały się głosy, że na stacji xyz nie można się zalogować do Realmu MIT. Wszelkie próby kończyły się informacją “Zły login lub hasło”:)<br /><br />Niestety z względu na wsteczną kompatybilność byłem zmuszony do wykorzystywania DES-CBC-CRC. Jak wiadomo&nbsp; DES został wyłączony w domyślnej instalacji Windows 7. O tym jak go włączyć pisałem w jednym z poprzednich postów.<br /><br />Niestety istnieją sytuacje, w których Windows 7 <em>nie uwzględnia</em> DES-CBC-CRC jako dozwolony typ szyfrowania:/ Nawet jeśli zostanie on włączony w rejestrze lub przez GP.<br /><br />Skrótowy schemat pozyskiwania kluczy podczas logowania jest następujący:<br /><ol><br /><li>System wysyła prośbę o odpowiednie tickety, prosząc o wykorzystanie najmocniejszego z obsługiwanych mechanizmów szyfrowania - w moim przypadku RC4-Hmac.</li><br /><li>Jeśli serwer kluczy (KDC) obsługuje dany typ szyfrowania to zwracany jest odpowiedni ticket. Jeśli jednak dany typ/typy nie jest obsługiwany to dostajemy zwrotkę: <em>KDC has no support for encryption type</em></li><br /><li>Jeśli klient otrzyma informacje o nieobsługiwanym typie szyfrowania to próbuje poprosić o ten sam ticket podając wspierane mechanizmy szyfrowania. W moim przypadku (RC4-HMAC, DEC-CBC-MD5, DES-CBC-CRC)</li><br /><li>Jeśli KDC kolejna zwrotka jest postaci: <em>KDC has no support for encryption type</em> to system wyświetli informacje <em>“ Błędny login lub hasło”.</em> Jeśli jednak hasło i typ szyfrowania był poprawny to system otrzyma odpowiednie tickety.</li></ol><br />Niestety, po pewnym czasie bezczynności na końcówce z&nbsp; Windows 7 nie można się zalogować do Realmu. Po zgłoszeniu tego problemu przez studentów priorytetem było zalogowanie użytkownika a nie sprawdzenie problemu:/ – o dziwo restart rozwiązywał problem. Oczywiście przez kilka dni można prosić użytkowników o restart sprzętu, jednak nie można sobie pozwolić na zastosowanie restartu jako ostatecznego rozwiązania naszego problemu.<br /><br />Dziś gdy testowałem pewne poprawki zauważyłem, że podczas wystąpienia w/w problemu system włączał oszczędzanie energii na karcie sieciowej. Po wznowieniu aktywności karta wracała do życia, niestety od tego czasu nie można się zalogować do realmu MIT Kerberos:/ Jak się okazało przy próbie zalogowania w logach KDC możemy zobaczyć komunikat typu:<br /><br /><em>kdc.realm krb5kdc[5102](info): AS_REQ (6 etypes {18 17 23 24 -135 3}) IP.ADDRESS: BAD_ENCRYPTION_TYPE: user@MIT.REALM for krbtgt/MIT.REALM@MITREALM, KDC has no support for encryption type </em><br /><br />Co ciekawe stacja wysyła dwie prośby o takiej samej treści a potem przestaje próbować negocjować odpowiedni mechanizm szyfrowania. Mimo włączenie DES-CBC-CRC nie jest on specyfikowany podczas komunikacji:/ Informacja o tym jest zawarta w <strong><em>(6 etypes{18 17 23 24 -135 3}). </em></strong>Te kilka cyfr mówi nam:<br /><br />Proszę o ticket zaszyfrowany jednym z 6 mechanizmów <em>(aes128-cts-hmac-sha1-96, aes256-cts-hmac-sha1-96, rc4-hmac, rc4-hmac-exp, .., des-cbc-md5).</em> Super wyłączyłem wykorzystanie aes a system mimo to chce z niego korzystać. Niestety nigdzie nie pojawia się numerek 1 – des-cbc-crc:/<br /><br />Jak się wstępnie okazuje jeśli w właściwościach karty sieciowej wyłączymy <em><strong>“Allow the computer to turn off this device to save power”</strong></em> to nawet po bardzo długim czasie bezczynności sprzętu (+-1,2h) z końcówki nadal można przeprowadzić logowanie do mitowskiego KDC. Oczywiście obecnie poprawka jest w fazie sprawdzania i jutro będzie testowana przez sporą liczbę studentów, jednak z tego co zdążyłem zauważyć w tygodniu ta drobna zmiana wykluczyła zgłaszanie problemów z logowaniem. Mam nadzieję, że nie jest to tylko kilkudniowy zbieg okoliczności…. cdn – pewnie po weekendzie:)<br /><br />Swoją drogą jak to zwykle bywa analiza logów MIT KDC opiera się o znajomość pewnych cyferek. <a href="http://www.iana.org/assignments/kerberos-parameters/kerberos-parameters.xml">Pod tym linkiem</a> można znaleźć kilka przydatnych numerków:)<br /><div style="text-align: center;"></div>