---

title: VMware– SCSI NMP error
date: '2012-02-27T01:51:00.000+01:00'
author: kaarol
tags:
- Wirtualizacja
- VMware
modified_time: '2015-03-03T00:19:10.419+01:00'
thumbnail: http://3.bp.blogspot.com/-n7lHqCANngQ/VPTvzUBk7sI/AAAAAAAAAAU/eO9QnqB7-6s/s72-c/scsi_error.png
blogger_id: tag:blogger.com,1999:blog-1272990746006552071.post-4045618095081245175
blogger_orig_url: http://www.it-flow.pl/2012/02/vmware-scsi-nmp-error.html
---

<div align="justify">Czasem zdarzają się sytuacje, w których przy stosunkowo małym ruchu występują spore opóźnienia lub problemy w dostępie do macierzy. Sama diagnostyka zazwyczaj zaczyna się od analizy wykresów dostępnych w vCenter lub sprawdzenia wyników esxtop na konkretnym hoście. Na podstawie zebranych danych często próbujemy przenieść cześć maszyn na inne LUNy czy optymalizować konfigurację kontrolerów dostępnych na określonych macierzach. Podczas procesu optymalizacji warto lub nawet trzeba przeglądnąć log vmkernel. W logu tym zapisywane są komunikaty scsci device NMP error, które mogą nam ułatwić analizę problemów występujących w naszym środowisku.</div><br /><div align="justify"><strong>Jak analizować błędy NMP?</strong></div><br /><div align="justify">Każdy wpis dotyczący błędów NMP zawiera kilka istotnych elementów:</div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-n7lHqCANngQ/VPTvzUBk7sI/AAAAAAAAAAU/eO9QnqB7-6s/s1600/scsi_error.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-n7lHqCANngQ/VPTvzUBk7sI/AAAAAAAAAAU/eO9QnqB7-6s/s1600/scsi_error.png" height="83" width="640" /></a></div><br /><ol><br /><ol><br /><li><br /><div align="justify">Data i godzina wystąpienia błędu, tutaj warto pamiętać, że hosty (ESXi) korzystają z czasu UTC.</div></li><br /><li><br /><div align="justify">Identyfikator problematycznego LUNu (naaID). W celu pozyskania dodatkowych informacji na temat określonego urządzenia możemy skorzystać z vClienta lub narzędzi CLI. Np. esxcli storage core path list -d &lt;naaID&gt; zwróci nam dokładniejsze informacje o LUNie o okreslonym naaID.</div></li><br /><li><br /><div align="justify"><strong>Status code</strong> – ogólny identyfikator problemu określający, który komponent/urządzenie zwróciło błąd:</div><br /><ul><br /><ul><br /><li><br /><div align="justify">H – błąd po stronie hosta</div></li><br /><li><br /><div align="justify">D – błąd zwrócony przez host docelowy</div></li><br /><li><br /><div align="justify">P – błąd wygenerowany przez plugin NMP</div></li></ul></ul><br /><br /><div align="justify">Kod 0x0 jest zwracany gdy nie zaobserwowano, żadnego błędu. Przykładowo H: 0x0 mówi nam, że po stronie hosta wszystko działa poprawnie. W zależności od problemów, możemy zaobserwować różne numery błędów:</div><br /><div align="justify"></div><br /><ul><br /><li><br /><div align="justify">0x2 – nieudane wykonanie określonej komendy, więcej informacji znajdziemy analizując dodatkowy numer (4)</div></li><br /><li><br /><div align="justify">0x8 – określone urządzenie jest zajęte i nie akceptuje komend SCSI.</div></li></ul><br /><div align="justify">Więcej informacji na temat najczęściej występujących&nbsp; statusów możemy znaleźć bezpośrednio na stronie vmware [<a href="http://kb.vmware.com/selfservice/documentLinkInt.do?micrositeID=&amp;popup=true&amp;languageId=&amp;externalID=1030381">KB1030381</a>].</div></li><br /><li><br /><div align="justify"><strong>Valid sense data:</strong> dodatkowe informacje na temat błędu zwróconego przez określone urządzenie. Przykładowo jeśli urządzenie docelowe zwróci nam status 0x2 oznaczający błędne wykonanie określonej komendy to Valid sense data pozwoli nam określić powód błędu.</div><br /><div align="justify"></div><br /><ul><br /><li><br /><div align="justify">Pierwszy numer w ciągu to Sense Key, którego opis możemy znaleźć na stronie&nbsp; [<a href="http://www.t10.org/lists/2sensekey.htm">t10.org</a>]</div></li><br /><li><br /><div align="justify">pozostałe dwa numery to&nbsp; Additional Sense Code/ ASC Qualifier. Dokładny ich opis można znaleźć na stronie [<a href="http://www.t10.org/lists/asc-num.htm">t10.org</a>]. Przy czym postać 0xX 0xY zapisana jest w postaci X/Y</div></li></ul></li></ol></ol><br /><strong>Przykładowa analiza</strong><br /><div align="justify">Na wyżej zamieszczonym zrzucie można zobaczyć, że na lunie o id naa.600cf….. wystąpił błąd o identyfikatorze <strong>H:0x0 D:0x2 P:0x0</strong> – problem po stronie urządzenia docelowego. Status 0x2 – nie udało się poprawnie wykonać komendy po stronie macierzy. Dodatkowy kod <strong>0x0 0x47 0x0</strong>&nbsp;&nbsp; zgodnie z opisem na stronie [<a href="http://www.t10.org/lists/asc-num.htm">t10.org</a>] wskazuje:</div><br /><br /><ul><br /><li><br /><div align="justify">sense code 0x0 – brak jakiegoś specyficznego błędu, wymagane sprawdzenie dodatkowych pól</div></li><br /><li><br /><div align="justify">additinal sense code 0x47 / ACS 0x0 – 47/00 SCSI PARITY ERROR – w zależności od konfiguracji problem może być związany nie z samym kontrolerem lecz z kablami lub urządzeniami występującymi między hostem a macierzą.</div></li></ul><br /><div align="justify"><strong>Konkluzje </strong></div><br /><div align="justify">Tak, wiem, po co analizować tak głęboko logi i studiować dokumentacje? Przecież od tego jest wsparcie techniczne.</div><br /><div align="justify">Primo – warto wiedzieć gdzie mamy zgłosić błąd (H: 0x0 D:0x2 P:0x0 – błąd po stronie macierzy, otwarcie zgłoszenia w na stronie VMware zakończy się odbiciem do producenta macierzy[: ) Zamiast marnować czas na odbijanie piłeczki, warto wiedzieć gdzie pisać w pierwszej kolejności.</div><br /><div align="justify">Secundo – jeśli skończy się nam wsparcie lub proces rozwiązania zgłoszenia będzie zbyt długi, warto mieć podstawowe informacje na temat problemu. Będziemy wiedzieli kiedy konsultant gra na zwłokę, a może własnymi siłami uda się rozwiązać problem.</div>